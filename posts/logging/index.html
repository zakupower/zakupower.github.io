<!doctype html><html lang=en><head><title>Turns out Logging is hard :: D. Tomov's Ramblings Repository</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Why is logging so hard?"><meta name=keywords content="java,logging"><meta name=robots content="noodp"><link rel=canonical href=https://zakupower.github.io/posts/logging/><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=https://zakupower.github.io/img/theme-colors/blue.png><link rel=apple-touch-icon href=https://zakupower.github.io/img/theme-colors/blue.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://zakupower.github.io"><meta name=twitter:creator content="Dimitar Tomov"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Turns out Logging is hard"><meta property="og:description" content="Why is logging so hard?"><meta property="og:url" content="https://zakupower.github.io/posts/logging/"><meta property="og:site_name" content="D. Tomov's Ramblings Repository"><meta property="og:image" content="https://zakupower.github.io/img/favicon/blue.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-11-23 22:13:30 +0200 +0200"></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>D. Tomov</div></a></div><div class=menu-trigger>menu</div></div><nav class="menu hidden-on-mobile"><ul class="menu__inner menu__inner--desktop"><li><a href=/>/root</a></li><li><a href=/readme>README.md</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/>/root</a></li><li><a href=/readme>README.md</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://zakupower.github.io/posts/logging/>Turns out Logging is hard</a></h1><div class=post-meta><time class=post-date>2022-11-23 ::</time>
<span class=post-author>Dimitar Tomov</span></div><span class=post-tags>#<a href=https://zakupower.github.io/tags/logging/>logging</a>&nbsp;
#<a href=https://zakupower.github.io/tags/experience/>experience</a>&nbsp;</span><div class=post-content><div><p>Turns out logging is hard! When I was a green junior developer I thought nothing of logging. It was just something that I knew I had to do. Rule I was following was, if exception occurs log it and rethrow if necessary. As it turns out that is the dumbest rule ever. Filling your logs with exceptions which are 1. already logged by application and 2. there is nothing useful about seeing them in the logs is unnecessary.</p><h2 id=how-it-began>How it began<a href=#how-it-began class=hanchor arialabel=Anchor>&#8983;</a></h2><p>I stumbled upon this issue with an application that was being used by 300+ users at the same time, and these users were very active in specific timeslots 8:30 am to 12:00 pm and 16:00 pm to 20:00 pm. When application was released on PROD there were so many other issues that were being reported on the daily, and all were critical so we didn&rsquo;t even notice how our logs went from 10 archived files per day to <strong>100 to 900 archived files for 1 day</strong>.</p><h2 id=what-were-the-issues>What were the issues<a href=#what-were-the-issues class=hanchor arialabel=Anchor>&#8983;</a></h2><p>After our logs took a turn for the worse, we started doing analysis on what the issues were.</p><h3 id=request-logging>Request logging<a href=#request-logging class=hanchor arialabel=Anchor>&#8983;</a></h3><p>We wanted to keep track of the calls to our endpoints, and have them all stored for future analysis. Also we had some very tricky bugs which we wanted to pin point this way. We had our request logs turned on from day 1 of PROD Release. Turns out from all these request logging our application was being slowed down a lot. After discussing with POs and the client, we found out that we assumed (wrongly) we wanted to keep track and store all endpoints, but it turned out we only needed one endpoint. So we turned off all logs for other endpoints and kept this one.</p><p>After some time, these logs were annoying to scroll through when looking at the other logs of the application, so we even moved this endpoint&rsquo;s logs to a different log file structure with its own RollingAppender. This significantly improved the situation, and we were happy with our decisions. Now we had a separate log file structure, which we could analyze if needed for this endpoint.</p><h3 id=the-obsolete-error-logging>The obsolete error logging<a href=#the-obsolete-error-logging class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This was not enough for us, we still had 100s of archived log files for a day. So we went on to the next culprit obsolete error logs</p><p>We gathered the logs from a single day of the application, and collected all errors which were logged. And we asked ourselves the question:</p><ul><li>Is this programmer or client error?<ul><li>If programmer error -> Fix it</li><li>If client error -> Truncate the error log as much as possible</li></ul></li></ul><p>There were multiple instances of validation errors, that we were just logging the whole stack trace and never using it for anything. These error were truncated to simple one line logs.</p><h3 id=unexpected-ddos>Unexpected &ldquo;DDOS&rdquo;<a href=#unexpected-ddos class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This issue is something we should have noticed first, but we were ignoring the obvious. The most frequent error in our logs was a Unique Constraint Violation, that was happening on the main (most used) table of the application.</p><p>Our most used endpoint, the one we were logging the requests for was an async operation, that validated the input without any DB hits and placed the request in a queue to be processed and return 200 OK, so the user doesn&rsquo;t have to wait on a very expensive chain of operations that would happen after this endpoint is called. The Frontend application had a retry mechanism (because the information for this endpoint was very important to never be lost) that would call this endpoint. For some reason the retry mechanism was not working properly and was retrying the same resource 1000s of times per day. So except the traffic we were getting from users, we were also getting these retry requests based on local storage in the frontend. When we did the analysis it turned out in the span of 1 week, we were being sent 1000s of resources 1000s of times a day which were all failing with Unique Constraint Violation.</p><p>We were being &ldquo;DDOS-ed&rdquo; by our own Frontend application, and this filled the logs to the brim and also slowed down the Backend application significantly (an issue we were also investigating in parallel to the logs).</p><p>The solution for this was fixing the Frontend Retry mechanism, and also adding a simple (and fast) DB call which would check for already existing resource on the specific endpoint and before queueing the resource for processing throwing a 422 UNPROCESSABLE ENTITY error to the frontend so it can delete it from the local storage.</p><h2 id=lessons-learned>Lessons learned<a href=#lessons-learned class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The biggest reason for our log issue, turned out to be unrelated to our logging, but in the process we learned, to be way more careful with what we log.</p><ol><li><strong>Always do a root cause analysis of the most frequent log lines in your application, even if they seem normal.</strong></li><li><strong>After a week or so of running your application in PROD, look at the logs your application, and eliminate unnecessary error and info logs.</strong></li><li><strong>Write meaningful error log messages instead of logging huge exception stack traces.</strong></li></ol><h2 id=useful-articles>Useful Articles<a href=#useful-articles class=hanchor arialabel=Anchor>&#8983;</a></h2><p><a href=https://www.freecodecamp.org/news/how-to-use-logs-effectively-in-your-code>To Log, or Not to Log - An Alternative Strategy to Make Loggers your Friends (by Stanley Nguyen)</a></p><p><a href=https://blog.codinghorror.com/the-problem-with-logging/>The Problem With Logging (by Jeff Atwood)</a></p><p><a href=https://sobolevn.me/2020/03/do-not-log>Do not log (by Nikita Sobolev)</a></p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other commits</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://zakupower.github.io/posts/java-17-upgrade/><span class=button__text>Migrating from Java 11 to 17</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>